import React, { useMemo, useState } from "react";
import TopBar from "../components/TopBar";
import CategoryDock from "../components/CategoryDock";
import CartPanel from "../components/CartPanel";

type Payment = "CARD" | "QR" | "CASH";

type Product = {
  id: number;
  name: string;
  price: number;
  emoji?: string;
  allergens?: string[];
  image?: string | null; // ç”»åƒURLï¼ˆãªã‘ã‚Œã° null/undefinedï¼‰
};

const categories = [
  { id: 1, name: "ã‚»ãƒƒãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼", emoji: "ğŸ±" },
  { id: 2, name: "å˜å“",         emoji: "ğŸ”" },
  { id: 3, name: "ãƒ‰ãƒªãƒ³ã‚¯",     emoji: "ğŸ¥¤" },
];

// â˜…ç”»åƒãŒã‚ã‚‹ã‚‚ã®ã¯ image: "/images/xxx.jpg" ç­‰ã‚’å…¥ã‚Œã¦ãã ã•ã„
const productsByCategory: Record<number, Product[]> = {
  1: [
    { id: 101, name: "Aã‚»ãƒƒãƒˆï¼ˆãƒãƒ¼ã‚¬ãƒ¼ï¼‹ãƒãƒ†ãƒˆï¼‹ãƒ‰ãƒªãƒ³ã‚¯ï¼‰", price: 850, emoji: "ğŸ”", allergens: ["å°éº¦","ä¹³"], image: null },
    { id: 102, name: "Bã‚»ãƒƒãƒˆï¼ˆãƒã‚­ãƒ³ï¼‹ã‚µãƒ©ãƒ€ï¼‹ãƒ‰ãƒªãƒ³ã‚¯ï¼‰",   price: 920, emoji: "ğŸ—", allergens: ["åµ"],       image: null },
  ],
  2: [
    { id: 201, name: "ãƒãƒ¼ã‚ºãƒãƒ¼ã‚¬ãƒ¼", price: 380, emoji: "ğŸ§€", allergens: ["å°éº¦","ä¹³"], image: null },
    { id: 202, name: "ãƒ•ãƒ©ã‚¤ãƒ‰ãƒãƒ†ãƒˆ", price: 260, emoji: "ğŸŸ", image: null },
    { id: 203, name: "ã‹ã‚‰ã‚ã’",       price: 320, emoji: "ğŸ—", allergens: ["å°éº¦"],      image: null },
  ],
  3: [
    { id: 301, name: "ã‚³ãƒ¼ãƒ©",         price: 200, emoji: "ğŸ¥¤", image: null },
    { id: 302, name: "ã‚ªãƒ¬ãƒ³ã‚¸",       price: 200, emoji: "ğŸŸ ", image: null },
    { id: 303, name: "ãƒ›ãƒƒãƒˆã‚³ãƒ¼ãƒ’ãƒ¼", price: 250, emoji: "â˜•", image: null },
  ],
};

export default function Home() {
  const [payment, setPayment] = useState<Payment | null>(null);
  const [selectedCategory, setSelectedCategory] = useState<number | null>(null);
  const [cart, setCart] = useState<Record<number, number>>({}); // { productId: qty }

  const inc = (id: number) => setCart(c => ({ ...c, [id]: (c[id] ?? 0) + 1 }));
  const dec = (id: number) => setCart(c => ({ ...c, [id]: Math.max(0, (c[id] ?? 0) - 1) }));

  const allProducts = useMemo(() => {
    const m = new Map<number, Product>();
    Object.values(productsByCategory).flat().forEach(p => m.set(p.id, p));
    return m;
  }, []);

  const cartItems = useMemo(() =>
    Object.entries(cart)
      .filter(([, q]) => (q ?? 0) > 0)
      .map(([id, q]) => ({ product: allProducts.get(Number(id))!, qty: q! as number }))
  , [cart, allProducts]);

  const onConfirm = () => {
    const total = cartItems.reduce((s, it) => s + it.product.price * it.qty, 0);
    alert(\æ³¨æ–‡ã‚’ç¢ºå®šã—ã¾ã—ãŸã€‚\næ”¯æ‰•ã„æ–¹æ³•ï¼š\\nåˆè¨ˆï¼šÂ¥\\);
  };

  return (
    <div className="min-h-[100svh] w-[100svw]">
      {/* 1) æ”¯æ‰•ã„é¸æŠ */}
      {payment === null && (
        <div className="h-[100svh] grid place-items-center">
          <div className="flex gap-6">
            {(["CARD","QR","CASH"] as Payment[]).map((m) => (
              <button
                key={m}
                onClick={() => setPayment(m)}
                className="w-20 h-20 rounded-full bg-white text-black text-2xl shadow-lg border border-gray-300"
                title={m}
              >
                {m === "CARD" ? "ğŸ’³" : m === "QR" ? "ğŸ“±" : "ğŸ’´"}
              </button>
            ))}
          </div>
        </div>
      )}

      {/* 2) ã‚«ãƒ†ã‚´ãƒªé¸æŠ */}
      {payment !== null && selectedCategory === null && (
        <div className="h-[100svh] grid place-items-center">
          <div className="flex gap-8">
            {categories.map((cat) => (
              <button
                key={cat.id}
                onClick={() => setSelectedCategory(cat.id)}
                className="w-24 h-24 rounded-full bg-white text-black shadow-lg border border-gray-200 font-semibold text-lg"
                title={cat.name}
              >
                <div className="text-3xl mb-1">{cat.emoji}</div>
                {cat.name}
              </button>
            ))}
          </div>
        </div>
      )}

      {/* 3) 3ã‚«ãƒ©ãƒ ï¼šä¸­å¤®ï¼èª¬æ˜ã‚¨ãƒªã‚¢ï¼ˆã‚¿ãƒƒãƒ—ã§è¿½åŠ ï¼‰ï¼å³ï¼æ³¨æ–‡ã‚¨ãƒªã‚¢ */}
      {payment !== null && selectedCategory !== null && (
        <div className="three-pane grid gap-[2px]">
          {/* å·¦ï¼šã‚«ãƒ†ã‚´ãƒª */}
          <aside className="pane-left p-1">
            <CategoryDock
              categories={categories}
              selectedId={selectedCategory}
              onSelect={(id) => setSelectedCategory(id)}
            />
          </aside>

          {/* ä¸­å¤®ï¼šå•†å“èª¬æ˜ï¼ˆå†™çœŸ/å/ä¾¡æ ¼/ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã®ã¿ï¼‰â†’ ã‚¿ãƒƒãƒ—ã§è¿½åŠ  */}
          <main className="pane-center">
            <div className="inner mx-auto w-full max-w-[680px] px-2">
              {(productsByCategory[selectedCategory] ?? []).map((p) => (
                <div
                  key={p.id}
                  role="button"
                  tabIndex={0}
                  onClick={() => inc(p.id)}
                  onKeyDown={(e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); inc(p.id); } }}
                  className="bg-white text-black rounded-xl shadow p-3 mb-2 cursor-pointer hover:shadow-md active:scale-[0.99] transition"
                >
                  <div className="flex items-center gap-3">
                    <div className="w-20 h-20 rounded-lg bg-gray-200 overflow-hidden flex items-center justify-center shrink-0">
                      {p.image ? (
                        <img src={p.image} alt={p.name} className="w-full h-full object-cover" />
                      ) : (
                        <span className="text-3xl">{p.emoji ?? "ğŸ½ï¸"}</span>
                      )}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="font-semibold truncate">{p.name}</div>
                      <div className="text-sm opacity-80">Â¥{p.price.toLocaleString()}</div>
                      {p.allergens?.length ? (
                        <div className="text-xs mt-1 opacity-80">ã‚¢ãƒ¬ãƒ«ã‚²ãƒ³: {p.allergens.join("ã€")}</div>
                      ) : null}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </main>

          {/* å³ï¼šæ”¯æ‰•ã„ãƒãƒ¼ + æ³¨æ–‡ãƒ‘ãƒãƒ« */}
          <section className="pane-right space-y-2 sticky top-[calc(var(--safe-top,0px)+8px)] self-start">
            <div className="payment-row">
              <TopBar payment={payment} onChange={setPayment} />
            </div>
            <CartPanel items={cartItems} onInc={(id:number)=>inc(id)} onDec={(id:number)=>dec(id)} onConfirm={onConfirm} />
          </section>
        </div>
      )}
    </div>
  );
}
